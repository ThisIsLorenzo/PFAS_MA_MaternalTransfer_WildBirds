---
title: "Code"
author: "LR"
date: '2022-06-28'
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Porpuse: This .Rmd document provides the code we used for data processing and data visualization.

## Data processing workflow.

We use a dm object to create a relational data model from our local data tables.
The six tables that we are working with contain data extracted from the
included studies. The six tables are named as follow: **study_info**, **species_info**, **pfas_info**,
**cohort_info**, **sample_info**, **measurements**.

```{r loading packages, message = FALSE, echo = TRUE, eval = TRUE, warning = FALSE}
library(tidyverse)
library(readr)
library(ape, curl)
library(rotl)
library(here)
library(dm)
library(dplyr)
library(metafor)
```

```{r loading data, include=FALSE}
st <- read_csv(here("Data", "study_info.csv"))
sp <- read_csv(here("Data", "species_info.csv"))
pfas <- read_csv(here("Data", "pfas_info.csv"))
co <- read_csv(here("Data", "cohort_info.csv"))
sa <- read_csv(here("Data", "sample_info.csv"))
me <- read_csv(here("Data", "measurement_info.csv"))
```

```{r cleaning - removing unnecessary columns (i.e., "Timestamp" and comment columns)}
st <- st %>% 
  select(-("Timestamp")) %>%
  select(-(ends_with("comment")))
sp <- sp %>% 
  select(-("Timestamp")) %>%
  select(-(ends_with("comment")))
pfas <- pfas %>% 
  select(-("Timestamp")) %>% 
  select(-(ends_with("comment")))
co <- co %>% 
  select(-("Timestamp")) %>%
  select(-(ends_with("comment")))
sa <- sa %>% 
  select(-("Timestamp")) %>% 
  select(-(ends_with("comment")))
me <- me %>%
  select(-("Timestamp")) %>% 
  select(-(ends_with("comment")))
```

### dm object - relational database

```{r adding tables to the dm object, include=FALSE}
data_dm_no_keys <- dm(st, sp, pfas, co, sa, me)
data_dm_no_keys
data_dm_no_keys$st
data_dm_no_keys[c("st", "co")]
```

```{r defining primary keys}
data_dm_only_pks <- data_dm_no_keys %>% 
  dm_add_pk(table = st, columns = study_ID) %>% 
  dm_add_pk(sp, species_ID) %>% 
  dm_add_pk(pfas, pfas_ID) %>% 
  dm_add_pk(co, cohort_ID) %>% 
  dm_add_pk(sa, sample_ID) %>% 
  dm_add_pk(me, measurement_ID)
data_dm_only_pks
```

```{r defining foreign keys}
data_dm_all_keys <- 
  data_dm_only_pks %>% 
  dm_add_fk(table = co, columns = study_ID, ref_table = st) %>% 
  dm_add_fk(table = co, columns = species_ID, ref_table = sp) %>%
  dm_add_fk(table = sa, columns = cohort_ID, ref_table = co) %>%
  dm_add_fk(table = me, columns = sample_ID, ref_table = sa) %>%
  dm_add_fk(table = me, columns = pfas_ID, ref_table = pfas)
data_dm_all_keys
```
```{r visualization}
data_dm_all_keys %>% 
  dm_draw()
```
```{r integrity check}
data_dm_all_keys %>% 
  dm_examine_constraints()
```

```{r merging all tables into one big table}
dm_joined <- 
  data_dm_all_keys %>% 
  dm_flatten_to_tbl(.start = me, .recursive = TRUE)
dm_joined
```

### Effect size
The `lnRR_func` function is here used to calculate a log response ratio (lnRR) adjusted for small sample sizes. In addition, this formula accounts for correlated samples. 
For more details, see *Doncaster and Spake (2018) Correction for bias in meta-analysis of little-replicated studies. Methods in Ecology and Evolution; 9:634-644*

```{r function to calculate effect size}
# Custom function to calculate the lnRR 
lnRR_func <- function(Mc, Nc, Me, Ne, aCV2c, aCV2e){
  lnRR <- log(Me/Mc) + 
        0.5 * ((aCV2e/Ne) - (aCV2c/Nc))	
  lnRR
}
# Custom function to calculate the lnRR's sampling variance from independent designs (rTC = 0)
var_lnRR_ind <- function(Mc, Nc, Me, Ne, aCV2c, aCV2e){
  
  var_lnRR <- (aCV2c/Nc) + (aCV2e/Ne) 
  
  var_lnRR
}
# Mc: Concentration of PFAS of the raw (control) sample
# Nc: Sample size of the raw (control) sample
# Me: Concentration of PFAS of the cooked (experimental) sample
# Ne: Sample size of the cooked (experimental) sample 
# aCV2c: Mean coefficient of variation of the raw (control) samples
# aCV2e: Mean coefficient of variation of the cooked (experimental) samples
```

### Generating the Phylogenetic Tree

```{r get list of species, message = FALSE, echo = TRUE, eval = TRUE, warning = FALSE}
myspecies <- as.character(unique(sp$species_scientific_name)) #get list of species
str_sort(myspecies) #visual check
length(myspecies) #16 species
length(unique(myspecies)) #16 unique species names
```






```{r - join matching rows of different data sets}
ms <- left_join(measurement_info, sample_info, by = "sample_ID")
msc <- left_join(ms, cohort_info, by = "cohort_ID")
mscs <- left_join(msc, study_info, by = "study_ID")
mscsp <- left_join(mscs, pfas_info, by = "pfas_ID")
mscsps <- left_join(mscsp, species_info, by = "species_ID")
data_combined <- mscsps %>% 
  select(-c(Timestamp.x, Timestamp.y, Timestamp.x.x, Timestamp.y.y, Timestamp.x.x.x, Timestamp.y.y.y))
View(data_combined)
```
# Clean the dataframe removing comment and statement columns
```{r cleaning}
data_combined <- data_combined %>% 
  select(- ends_with("comment")) %>% 
  select(- ends_with("statement"))
```
# Remove rows having NA values in mean_arithmetic, SD, or n columns
```{r remove na}
data_combined <- data_combined %>% drop_na(mean_arithmetic, SD, n)
```

```{r}
p <- ggplot(data_combined)+
  geom_boxplot(aes(x=group_info, lower=mean_arithmetic-SD, upper=mean_arithmetic+SD, middle=mean_arithmetic, ymin=mean_arithmetic-3*SD, ymax=mean_arithmetic+3*SD), stat = "identity")
p
```


## To calculate the overall [PFAS]adult / [PFAS]progeny ratio I need to devide the mean of egg for the mean of adult (group_info).
```{r}
#progeny <- filter(data_combined, group_info == "egg" | group_info == "chick")
#adult <- filter(data_combined, group_info == "adult")
#ggplot(data_combined) %>% 
  #geom_point(aes(x=group_by() mean_arithmetic, y=adult$mean_arithmetic))
```

## Summary of scientific and common names of the species
```{r}
data_combined %>% group_by(species_scientific_name, species_common_name) %>% summarise()
```

## Overall meta-analytic mean calculation:
```{r}
#TODO


```


